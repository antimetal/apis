// Antimetal API definitions
// Copyright Antimetal, Inc. All rights reserved.
//
// Use of this source code and APIs are governed by a source available license that can be found in
// the LICENSE file or at:
// https://polyformproject.org/wp-content/uploads/2020/06/PolyForm-Shield-1.0.0.txt

syntax = "proto3";

package service.resource.v1;

import "resource/v1/object.proto";

// IntakeService is used to create, update, and delete infrastructure graph
// objects. The Service ingests Resources/Relationships from various sources.
// Delta() allows clients to stream in changes to the infrastructure graph.
//
// Objects can have a TTL set, which defines the lifetime of the object.
// It is used to clean up objects in the graph in the event of client failure
// to ensure that the state of the graph represents to most current view of the
// infrastructure. The TTL can be refreshed by sending a "Hearbeat" Delta
// operation containing objects whose TTLs are to be refreshed.
//
// Objects also contain a delta_version that is used to keep track of the state
// of individual objects. The version is set and maintained by the client
// sending Deltas. When sending heartbeat Deltas, to refresh the object, the
// client uses the delta_version of the last known change to the Object.
service IntakeService {
  rpc Delta(stream DeltaRequest) returns (DeltaResponse) {}
}

message DeltaRequest {
  string client_id = 1;
  repeated Delta deltas = 2;
}

message DeltaResponse {}

// Delta is a set of graph objects that is being modified by operation op.
message Delta {
  DeltaOperation op = 1;
  repeated .resource.v1.Object objects = 2;
}

// DeltaOperation is the type of change that is being made to the object.
enum DeltaOperation {
  // Create a new object in the graph.
  DELTA_OPERATION_CREATE = 0;
  // Update an existing object in the graph.
  DELTA_OPERATION_UPDATE = 1;
  // Delete an object from the graph.
  DELTA_OPERATION_DELETE = 2;
  // Heartbeat is a special type of delta that is used to keep an object with a
  // TTL alive.
  DELTA_OPERATION_HEARTBEAT = 3;
}
